(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{Pqdj:function(e,A,a){"use strict";a.r(A),a.d(A,"Title",(function(){return o})),a.d(A,"_frontmatter",(function(){return c})),a.d(A,"default",(function(){return b}));a("91GP"),a("rGqo"),a("yt8O"),a("Btvt"),a("RW0V"),a("q1tI");var t=a("7ljp"),n=a("013z");a("qKvR");function s(){return(s=Object.assign||function(e){for(var A=1;A<arguments.length;A++){var a=arguments[A];for(var t in a)Object.prototype.hasOwnProperty.call(a,t)&&(e[t]=a[t])}return e}).apply(this,arguments)}var i,o=function(){return Object(t.b)("span",null,"Modernizing runtimes with Liberty ",Object(t.b)("br",null)," ",Object(t.b)("h2",null,"Managing session state in an application"))},c={},l=(i="PageDescription",function(e){return console.warn("Component "+i+" was not imported, exported, or provided by MDXProvider as global scope"),Object(t.b)("div",e)}),r={Title:o,_frontmatter:c},p=n.a;function b(e){var A=e.components,a=function(e,A){if(null==e)return{};var a,t,n={},s=Object.keys(e);for(t=0;t<s.length;t++)a=s[t],A.indexOf(a)>=0||(n[a]=e[a]);return n}(e,["components"]);return Object(t.b)(p,s({},r,a,{components:A,mdxType:"MDXLayout"}),Object(t.b)(l,{mdxType:"PageDescription"},"Best practices and techniques to managing session state in an application when modernizing"),Object(t.b)("h1",null,"Session state management considerations"),Object(t.b)("p",null,"One of the ",Object(t.b)("a",s({parentName:"p"},{href:"https://12factor.net/"}),"12 factor")," principles is that applications and services should be stateless. Many existing monolith applications rely heavily on HTTP sessions. When you are modernizing your application it is a good practice to rearchitect them to be stateless, but some times it is not an easy task and you need to postpone it for a while."),Object(t.b)("p",null,"There are following methods that you can use in container world to handle session state, depending on your requirements:"),Object(t.b)("ul",null,Object(t.b)("li",{parentName:"ul"},"session affinity"),Object(t.b)("li",{parentName:"ul"},"session replication using caching mechanisms"),Object(t.b)("li",{parentName:"ul"},"session persistence using database")),Object(t.b)("h2",null,"Session affinity"),Object(t.b)("p",null,"Session affinity is the simplest mechanism for maintaining session state. Using this mechanism, requests from the same session will be routed to the same POD. Selecting this solution, you have to be aware that PODs are not like on-premise servers, they may be restarted much often, in many circumstances. So this solution might be applicable to applications that need relatively short lived sessions, and can tolerate loosing session data."),Object(t.b)("h3",null,"Deploying with session affinity"),Object(t.b)("p",null,"Session affinity on OpenShift utilizes Route configuration. You donâ€™t have to make any changes in your application code or during building application container, all is done on deployment time."),Object(t.b)("p",null,"In this example, a simple application has been deployed to WebSphere Liberty that displays the contents of the ",Object(t.b)("em",{parentName:"p"},"session")," and allows updates to be made to a ",Object(t.b)("em",{parentName:"p"},"counter")," that is stored in the session as well as displaying the name of the ",Object(t.b)("em",{parentName:"p"},"pod")," that services the request. There are multiple instances of the application pod running:"),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{}),"oc get pods | grep sample\nsession-sample-1-bzpd7   1/1     Running   0          10d\nsession-sample-1-dnpsg   1/1     Running   0          10d\nsession-sample-1-g5c8k   1/1     Running   0          21d\n")),Object(t.b)("p",null,"On the first request, the output is as shown below with the name of the pod an empty session. Since this is first request, currently there is no data in the session. You can also see name of the pod that runs the application."),Object(t.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"949px"}},"\n      ",Object(t.b)("span",s({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"19.09722222222222%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdqwJB//xAAVEAEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAQABBQIv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFhABAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEBAAE/IdpqwFhf/9oADAMBAAIAAwAAABAED//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/EGf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAEAAwADAAAAAAAAAAAAAAABABExYZHR/9oACAEBAAE/EKpirlHkRodTgJ//2Q==')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(t.b)("img",s({parentName:"span"},{className:"gatsby-resp-image-image",alt:"app1",title:"app1",src:"/static/66369ce67a37d0bfbfbaa00a5d7bbcda/8898a/oc-app1.jpg",srcSet:["/static/66369ce67a37d0bfbfbaa00a5d7bbcda/69549/oc-app1.jpg 288w","/static/66369ce67a37d0bfbfbaa00a5d7bbcda/473e3/oc-app1.jpg 576w","/static/66369ce67a37d0bfbfbaa00a5d7bbcda/8898a/oc-app1.jpg 949w"],sizes:"(max-width: 949px) 100vw, 949px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    "),Object(t.b)("p",null,"After a few requests to the app, using the link or reloading the page, the the counter value that is taken from the session increases as shwon below. Note that the requests are routed to the same pod. Session affinity is working."),Object(t.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"947px"}},"\n      ",Object(t.b)("span",s({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"18.40277777777778%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdm0JB//xAAVEAEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAQABBQIv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxABAQEBAAAAAAAAAAAAAAAAAQARUf/aAAgBAQABPyHaCsByw5f/2gAMAwEAAgADAAAAEIQP/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8QZ//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAAIDAQEAAAAAAAAAAAAAAAABETGRYdH/2gAIAQEAAT8Qk1l2oXg5aYcGH//Z')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(t.b)("img",s({parentName:"span"},{className:"gatsby-resp-image-image",alt:"app2",title:"app2",src:"/static/cf6669ebd846c92dc6bd1fb865a5428a/7aa6d/oc-app2.jpg",srcSet:["/static/cf6669ebd846c92dc6bd1fb865a5428a/69549/oc-app2.jpg 288w","/static/cf6669ebd846c92dc6bd1fb865a5428a/473e3/oc-app2.jpg 576w","/static/cf6669ebd846c92dc6bd1fb865a5428a/7aa6d/oc-app2.jpg 947w"],sizes:"(max-width: 947px) 100vw, 947px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    "),Object(t.b)("p",null,"If the pod is then deleted it will be replaced by OpenShift:"),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{}),'oc delete pod session-sample-1-g5c8k\npod "session-sample-1-g5c8k" deleted\n\noc get pods | grep sample\nsession-sample-1-5hzd5   1/1     Running   0          3m\nsession-sample-1-7w8gh   1/1     Running   0          23s\nsession-sample-1-dnpsg   1/1     Running   0          10d\n')),Object(t.b)("p",null,"If an attempt is then made to refresh the browser page or increment the count then the request is routed to the different pod and session state is lost:"),Object(t.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"951px"}},"\n      ",Object(t.b)("span",s({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"18.055555555555554%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdmwJA//xAAWEAADAAAAAAAAAAAAAAAAAAABECH/2gAIAQEAAQUCFf8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxABAQEBAAAAAAAAAAAAAAAAAQBREf/aAAgBAQABPyFoFYDLhl//2gAMAwEAAgADAAAAEHQP/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8QZ//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAAICAwEAAAAAAAAAAAAAAAABEZEhMWHR/9oACAEBAAE/EMxR7ULwcmUo4KP/2Q==')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(t.b)("img",s({parentName:"span"},{className:"gatsby-resp-image-image",alt:"app4",title:"app4",src:"/static/7625b1da0bb7dc0763f7120f9bcbb62c/db819/oc-app3.jpg",srcSet:["/static/7625b1da0bb7dc0763f7120f9bcbb62c/69549/oc-app3.jpg 288w","/static/7625b1da0bb7dc0763f7120f9bcbb62c/473e3/oc-app3.jpg 576w","/static/7625b1da0bb7dc0763f7120f9bcbb62c/db819/oc-app3.jpg 951w"],sizes:"(max-width: 951px) 100vw, 951px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    "),Object(t.b)("p",null,"If you want to ensure that session state is not lost when pod is removed, you will need to configure session caching or session persistence."),Object(t.b)("h2",null,"Session replication using caching mechanisms"),Object(t.b)("p",null,"Very often session affinity is not enough for application requirements and you need session state to be preserved in case of pod failure. One of the mechanisms that could be used is ",Object(t.b)("em",{parentName:"p"},"session caching"),". WebSphere Liberty has a ",Object(t.b)("inlineCode",{parentName:"p"},"sessionCache-1.0")," feature which provides distributed in-memory HttpSession caching. The ",Object(t.b)("inlineCode",{parentName:"p"},"sessionCache-1.0")," feature builds on top of an existing technology called ",Object(t.b)("a",s({parentName:"p"},{href:"https://www.jcp.org/en/jsr/detail?id=107"}),"JCache (JSR 107)"),", which offers a standardized distributed in-memory caching API."),Object(t.b)("p",null,"The ",Object(t.b)("inlineCode",{parentName:"p"},"sessionCache-1.0")," feature does not include a JCache implementation, so you need to pick one and reference it as a ",Object(t.b)("inlineCode",{parentName:"p"},"<library>")," in your ",Object(t.b)("inlineCode",{parentName:"p"},"server.xml"),". WebSphere/Open Liberty supports the following JCache implementations:"),Object(t.b)("ul",null,Object(t.b)("li",{parentName:"ul"},"Hazelcast"),Object(t.b)("li",{parentName:"ul"},"WebSphere Extreme Scale"),Object(t.b)("li",{parentName:"ul"},"Infinispan"),Object(t.b)("li",{parentName:"ul"},"Ehcache")),Object(t.b)("h3",null,"Prepare DockerFile with caching configuration"),Object(t.b)("p",null,"This article shows how to enable ",Object(t.b)("a",s({parentName:"p"},{href:"https://hazelcast.org/"}),"Hazelcast In-Memory Data Grid"),", as it is easily available in many private cloud solutions."),Object(t.b)("p",null,"Enabling Hazelcast session caching retrieves the Hazelcast client libraries from the ",Object(t.b)("a",s({parentName:"p"},{href:"https://hub.docker.com/r/hazelcast/hazelcast/"}),"hazelcast/hazelcast")," Docker image, configures Hazelcast by copying a sample hazelcast.xml, and configures the Liberty server feature sessionCache-1.0 by including the XML snippet hazelcast-sessioncache.xml. By default, the Hazelcast Discovery Plugin for Kubernetes will auto-discover its peers within the same Kubernetes namespace. To enable this functionality, the Docker image author can include the following Dockerfile snippet, and choose from either client-server or embedded topology."),Object(t.b)("p",null,"Modify your current Dockerfile with the following lines:"),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{className:"language-dockerfile"}),'### Hazelcast Session Caching ###\n# Copy the Hazelcast libraries from the Hazelcast Docker image - paths for WebSphere Liberty\nCOPY --from=hazelcast/hazelcast --chown=1001:0 /opt/hazelcast/lib/*.jar /opt/ibm/wlp/usr/shared/resources/hazelcast/\n\n# Copy the Hazelcast libraries from the Hazelcast Docker image - paths for Open Liberty\n# COPY --from=hazelcast/hazelcast --chown=1001:0 /opt/hazelcast/lib/*.jar /opt/ol/wlp/usr/shared/resources/hazelcast/\n\n# Instruct configure.sh to copy the client topology hazelcast.xml\nARG HZ_SESSION_CACHE=client\n\n# Instruct configure.sh to copy the embedded topology hazelcast.xml and set the required system property\n#ARG HZ_SESSION_CACHE=embedded\n#ENV JAVA_TOOL_OPTIONS="-Dhazelcast.jcache.provider.type=server ${JAVA_TOOL_OPTIONS}"\n\n## This script will add the requested XML snippets and grow image to be fit-for-purpose\nRUN configure.sh\n')),Object(t.b)("h3",null,"Deploy Hazelcast in OpenShift"),Object(t.b)("p",null,"Hazelcast can be used in OpenShift. By default it requires paid version - Hazelcast Enterprise. But you can use also free version ",Object(t.b)("a",s({parentName:"p"},{href:"https://github.com/hazelcast/hazelcast-code-samples/blob/master/hazelcast-integration/openshift/hazelcast-cluster/hazelcast-openshift-origin"}),"Hazelcast OpenShift Origin"),". See details on this page ",Object(t.b)("a",s({parentName:"p"},{href:"https://github.com/hazelcast/hazelcast-code-samples/tree/master/hazelcast-integration/openshift"}),"Hazelcast for OpenShift")),Object(t.b)("p",null,"For this article you will use Hazelcast OpenShift Origin."),Object(t.b)("h4",null,"Deploy Hazelcast cluster"),Object(t.b)("p",null,"Easiest way to deploy Hazelcast is to use ",Object(t.b)("a",s({parentName:"p"},{href:"https://github.com/hazelcast/hazelcast-code-samples/blob/master/hazelcast-integration/openshift/hazelcast-cluster/hazelcast-openshift-origin/hazelcast.yaml"}),"hazelcast.yaml")," file provided by Hazelcast"),Object(t.b)("p",null,"Create project for Hazelcast cluster"),Object(t.b)("p",null,Object(t.b)("inlineCode",{parentName:"p"},"$ oc new-project appmod-hazelcast")),Object(t.b)("p",null,"Deploy Hazelcast cluster"),Object(t.b)("p",null,Object(t.b)("inlineCode",{parentName:"p"},"$ oc new-app -f hazelcast.yaml -p NAMESPACE=appmod-hazelcast")),Object(t.b)("p",null,"Check the status of deployed cluster"),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{}),"$ oc get all\nNAME              READY     STATUS              RESTARTS   AGE\npod/hazelcast-0   1/1       Running             0          1m\npod/hazelcast-1   1/1       Running             0          42s\npod/hazelcast-2   0/1       ContainerCreating   0          2s\n\nNAME                        TYPE           CLUSTER-IP        EXTERNAL-IP                     PORT(S)          AGE\nservice/hazelcast-service   LoadBalancer   x.x.x.x             y.y.y.y                       5701:32567/TCP   1m\n\nNAME                         DESIRED   CURRENT   AGE\nstatefulset.apps/hazelcast   3         3         1m\n")),Object(t.b)("p",null,"This cluster contains 3 replicas, look in one of the pods logs to check if all members are correctly detected. Look for similar messages:"),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{}),"$ oc get pods\n\nMembers {size:3, ver:7} [\n    Member [192.168.16.15]:5701 - 9dc4af56-6df8-4a65-9890-68bf99e0ea5a\n    Member [192.168.12.16]:5701 - f927d37c-860d-4b38-88b4-b1f3dd97bfd1 this\n    Member [192.168.22.15]:5701 - ec8602a7-59b0-4dab-8446-3a8f32dac845\n]\n")),Object(t.b)("h4",null,"Deploy OpenLiberty configured for Hazelcast"),Object(t.b)("p",null,"The Hazelcast client configured with OpenLiberty is using Kubernetes API to find Hazelcast cluster and requires a new ServiceAccount and ClusterRoleBinding"),Object(t.b)("p",null,"Create project for the client application:"),Object(t.b)("p",null,Object(t.b)("inlineCode",{parentName:"p"},"$ oc new-project appmod-hazelcast-liberty")),Object(t.b)("p",null,"Create a new ServiceAccount:"),Object(t.b)("p",null,Object(t.b)("inlineCode",{parentName:"p"},"$ oc create serviceaccount hazelcast-liberty -n appmod-hazelcast-liberty")),Object(t.b)("p",null,"Create rbac.yaml with the following content:"),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{className:"language-yaml"}),"apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: default-cluster\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: view\nsubjects:\n- kind: ServiceAccount\n  name: hazelcast-liberty\n  namespace: appmod-hazelcast-liberty\n\n")),Object(t.b)("p",null,"Then, apply ",Object(t.b)("inlineCode",{parentName:"p"},"rbac.yaml"),":"),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{className:"language-bash"}),"$ kubectl apply -f rbac.yaml\n")),Object(t.b)("p",null,Object(t.b)("em",{parentName:"p"},"Note"),": You can be even more strict with the permissions and create your own Role. For details, please check the implementation of ",Object(t.b)("a",s({parentName:"p"},{href:"https://github.com/helm/charts/tree/master/stable/hazelcast"}),"Hazelcast Helm Chart"),"."),Object(t.b)("p",null,"The following changes are required to a WebSphere Liberty deployment on OpenShift in order to use Hazelcast:"),Object(t.b)("ul",null,Object(t.b)("li",{parentName:"ul"},"an environment variable: ",Object(t.b)("inlineCode",{parentName:"li"},"KUBERNETES_NAMESPACE")," that is set to the namespace that Hazelcast is deployed in to"),Object(t.b)("li",{parentName:"ul"},"the deployment much be updated to use the new serviceAccount by adding  the following to the ",Object(t.b)("inlineCode",{parentName:"li"},"template/spec")," section:")),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{}),"serviceAccountName: hazelcast-liberty\nserviceAccount: hazelcast-liberty\n")),Object(t.b)("p",null,"In order to validate that the in-memory session cache is working a similar test to the session affinity test is executed. There are two pods running the application:"),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{}),"oc get pods\nNAME                     READY   STATUS    RESTARTS   AGE\nsession-hazel3-2-425tr   1/1     Running   0          9d\nsession-hazel3-2-p5gtd   1/1     Running   0          9d\n")),Object(t.b)("p",null,"On the first request shown below, the session is empty and the pod is ",Object(t.b)("inlineCode",{parentName:"p"},"session-hazel3-2-425tr")),Object(t.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"912px"}},"\n      ",Object(t.b)("span",s({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"19.09722222222222%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdm0JB//xAAWEAADAAAAAAAAAAAAAAAAAAABECH/2gAIAQEAAQUCFf8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxABAQEBAAAAAAAAAAAAAAAAAQARUf/aAAgBAQABPyFoFYDlhf/aAAwDAQACAAMAAAAQBA//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBn/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAIDAQAAAAAAAAAAAAAAAQAhETFhkf/aAAgBAQABPxBil7MEYWPJwJ//2Q==')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(t.b)("img",s({parentName:"span"},{className:"gatsby-resp-image-image",alt:"app1",title:"app1",src:"/static/2a488dbf87ccd2de3dd11bf9b81d6518/2e6df/hazel-oc-app1.jpg",srcSet:["/static/2a488dbf87ccd2de3dd11bf9b81d6518/69549/hazel-oc-app1.jpg 288w","/static/2a488dbf87ccd2de3dd11bf9b81d6518/473e3/hazel-oc-app1.jpg 576w","/static/2a488dbf87ccd2de3dd11bf9b81d6518/2e6df/hazel-oc-app1.jpg 912w"],sizes:"(max-width: 912px) 100vw, 912px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    "),Object(t.b)("p",null,"After a few requests to the app, the same pod is being used and the session is being retained"),Object(t.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"911px"}},"\n      ",Object(t.b)("span",s({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"20.48611111111111%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdqwJB//xAAWEAADAAAAAAAAAAAAAAAAAAABECH/2gAIAQEAAQUCFf8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFhABAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEBAAE/ITjVYCwv/9oADAMBAAIAAwAAABD0D//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/EGf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAEAAQUBAAAAAAAAAAAAAAABABFBYXGR0f/aAAgBAQABPxBBrWjyXQcmAn//2Q==')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(t.b)("img",s({parentName:"span"},{className:"gatsby-resp-image-image",alt:"app2",title:"app2",src:"/static/fa572f6fc02445b870e01dfe573ae6cf/74252/hazel-oc-app2.jpg",srcSet:["/static/fa572f6fc02445b870e01dfe573ae6cf/69549/hazel-oc-app2.jpg 288w","/static/fa572f6fc02445b870e01dfe573ae6cf/473e3/hazel-oc-app2.jpg 576w","/static/fa572f6fc02445b870e01dfe573ae6cf/74252/hazel-oc-app2.jpg 911w"],sizes:"(max-width: 911px) 100vw, 911px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    "),Object(t.b)("p",null,"If the pod is then deleted it will be replaced by OpenShift:"),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{}),'oc delete pod session-hazel3-2-425tr\npod "session-hazel3-2-425tr" deleted\n\noc get pods\nNAME                     READY   STATUS    RESTARTS   AGE\nsession-hazel3-2-p5gtd   1/1     Running   0          9d\nsession-hazel3-2-wc4wd   1/1     Running   0          18s\n')),Object(t.b)("p",null,"If an attempt is then made to refresh the browser page or increment the count then the request is routed to the different pod (",Object(t.b)("inlineCode",{parentName:"p"},"session-hazel3-2--wc4wd"),") but the session state is retained:"),Object(t.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"912px"}},"\n      ",Object(t.b)("span",s({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"19.09722222222222%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdm0JB//xAAVEAEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAQABBQIv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxABAQEBAAAAAAAAAAAAAAAAAQARUf/aAAgBAQABPyHSCsBywv/aAAwDAQACAAMAAAAQhA//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBn/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAMAAwAAAAAAAAAAAAAAAQARIWGR0f/aAAgBAQABPxC7VXUo8jDR1OAn/9k=')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(t.b)("img",s({parentName:"span"},{className:"gatsby-resp-image-image",alt:"app4",title:"app4",src:"/static/017cce7bd6d2fc4e567b6a6526669f37/2e6df/hazel-oc-app3.jpg",srcSet:["/static/017cce7bd6d2fc4e567b6a6526669f37/69549/hazel-oc-app3.jpg 288w","/static/017cce7bd6d2fc4e567b6a6526669f37/473e3/hazel-oc-app3.jpg 576w","/static/017cce7bd6d2fc4e567b6a6526669f37/2e6df/hazel-oc-app3.jpg 912w"],sizes:"(max-width: 912px) 100vw, 912px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    "),Object(t.b)("h2",null,"Session persistence using database"),Object(t.b)("p",null,"In some cases you may want to use database instead of cache for storing session data, especially if you earlier already were using database as session persistent layer."),Object(t.b)("p",null,"WebSphere Liberty fully supports session persistence using data base using ",Object(t.b)("inlineCode",{parentName:"p"},"sessionDatabase-1.0")," feature. You will utilize dynamic configuration support in Liberty to configure session persistence without modifying your original server configuration."),Object(t.b)("h3",null,"Liberty configuration"),Object(t.b)("p",null,"Create new configuration file ",Object(t.b)("inlineCode",{parentName:"p"},"session-db.xml")," with the following contents. It configures required feature, database driver libraries, datasource, and http session management."),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{className:"language-xml"}),'<server description="Demonstrates HTTP Session Persistence Configuration">\n  <featureManager>\n          <feature>sessionDatabase-1.0</feature>\n  </featureManager>\n\n  <library id="DB2Lib">\n    <fileset dir="${server.config.dir}/resources/db2" includes="*.jar"/>\n  </library>\n\n  <dataSource id="SessionsDS">\n    <jdbcDriver libraryRef="DB2Lib"/>\n    <properties.db2.jcc databaseName="${env.DB2_DBNAME}" password="${env.DB2_PASSWORD}" portNumber="${env.DB2_PORT}" serverName="${env.DB2_HOST}" user="${env.DB2_USER}"/>\n    <connectionManager agedTimeout="0" connectionTimeout="180" maxIdleTime="1800" maxPoolSize="10" minPoolSize="1" reapTime="180"/>\n  </dataSource>\n\n  <httpSessionDatabase id="SessionDB" dataSourceRef="SessionsDS"/>\n  <httpSession cloneId="${env.HOSTNAME}"/>\n\n</server>\n\n')),Object(t.b)("p",null,"In the configuration you are utilizing environment variables for database access parameters such as host, port, userid, etc (e.g. ",Object(t.b)("inlineCode",{parentName:"p"},"${env.DB2_HOST}"),"). These variables will be provided during the deployment."),Object(t.b)("h3",null,"Modifying the Dockerfile"),Object(t.b)("p",null,"As now solution requires additional configuration file and database driver to access session database, that needs to be added to the Dockerfile."),Object(t.b)("pre",null,Object(t.b)("code",s({parentName:"pre"},{}),"# session persistence\nCOPY --chown=1001:0 db2drivers/ /config/resources/db2\nCOPY --chown=1001:0 src/main/liberty/config/session-db.xml /config/configDropins/overrides/\n")),Object(t.b)("h3",null,"Deploying to OpenShift"),Object(t.b)("p",null,"The only changes required to an existing WebSphere Liberty deployment are to add the Environment Variables for the DB2 database that is being used as the session database:"),Object(t.b)("ul",null,Object(t.b)("li",{parentName:"ul"},"Environment Variables: ",Object(t.b)("inlineCode",{parentName:"li"},"DB2_HOST"),", ",Object(t.b)("inlineCode",{parentName:"li"},"DB2_PORT"),", ",Object(t.b)("inlineCode",{parentName:"li"},"DB2_DBNAME"),", ",Object(t.b)("inlineCode",{parentName:"li"},"DB2_USER")," and ",Object(t.b)("inlineCode",{parentName:"li"},"DB2_PASSWORD")," should be added to the deployment.")),Object(t.b)("p",null,"The same test that has been used for ",Object(t.b)("em",{parentName:"p"},"session affinity")," and ",Object(t.b)("em",{parentName:"p"},"in-memory session cache")," can be used to validate ",Object(t.b)("em",{parentName:"p"},"session persistence using a database"),"."),Object(t.b)("h2",null,"Summary"),Object(t.b)("p",null,"In this article we have demonstrated how to use session affinity, session caching using an in-memory cache and session persistence using a database with WebSphere Liberty on OpenShift."))}b.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-applications-liberty-liberty-sessions-mdx-c09e823b63283cdedb4d.js.map